<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="">
  <meta property="og:type" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="">

  <link rel="manifest" href="site.webmanifest">
  <link rel="apple-touch-icon" href="icon.png">
  <!-- Place favicon.ico in the root directory -->

  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/style.css">

  <meta name="theme-color" content="#fafafa">
</head>

<body>
  <div class="carousel">
    <div class="item">
      <div id="model-container">
        <model-viewer src="models/molecule.glb" id="molecule" auto-rotate camera-controls interaction-prompt
          max-camera-orbit='auto auto 15m' min-camera-orbit='auto auto 15m' camera-orbit='auto auto 15m'
          loading='eager'>
          <div id="annotation-name"></div>
          <div id="annotation-details">
            <div id="details-title"> </div>
            <div class="row">
              Small Imatinib is an antineoplastic agent that inhibits the Bcr-Abl fusion protein tyrosine kinase, an
              abnormal enzyme produced by chronic myeloid leukemia cells that contain the Philadelphia chromosome.
              Imatinib also inhibits the receptor tyrosine kinases for platelet-derived growth factor (PDGF) and stem
              cell factor (SCF)/c-kit; the SCF/c-kit receptor tyrosine kinase is activated in gastrointestinal stroll
              tumor (GIST). This agent inhibits proliferation and induces apoptosis in cells that overexposes these
              oncoprotein.
            </div>
          </div>
        </model-viewer>
      </div>
    </div>
    <div class="item">
      <div id="model-container">
        <model-viewer src="models/skin.glb" id="skin" auto-rotate camera-controls interaction-prompt
          max-camera-orbit='auto auto 60m' min-camera-orbit='auto auto 60m' camera-orbit='auto auto 60m'
          loading='eager'>
          <div id="annotation-name"></div>
          <div id="annotation-details">
            <div id="details-title"> </div>
            <div class="row">
              This model depicts the anatomy of the skin. It is part of a dermatology e-learning module for medical
              students of the University of Groningen. </div>
          </div>
        </model-viewer>
      </div>
    </div>
  </div>
  <div id="link-debug"></div>

  <div id="qr-container">

    <div id="qr-title">Scan QR to control with your phone</div>
    <div id="placeHolder"> </div>
  </div>
  <!-- <div id="footer">
    <div id="footer-link"><a href="https://touchless.valtech.engineering"> Valtech Touchless Experiences</a></div>
  </div> -->
  <!--google model viewer-->
  <script type="module"
    src="https://modelviewer.dev/node_modules/@google/model-viewer/dist/model-viewer.min.js"></script>

  <!-- The core Firebase JS SDK is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/7.16.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.16.0/firebase-database.js"></script>

  <!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
  <script src="https://www.gstatic.com/firebasejs/7.16.0/firebase-analytics.js"></script>

  <!--QR code generator-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>

  <!--physics-->
  <script src="https://unpkg.com/popmotion/dist/popmotion.global.min.js"></script>
  <!--cookie handler -->
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>

  <script>
    // Your web app's Firebase configuration
    var firebaseConfig = {
      apiKey: "AIzaSyDNzSRFhlT_Nch6TTB3UZTpFfvW0m8sa1Q",
      authDomain: "touchless-qr.firebaseapp.com",
      databaseURL: "https://touchless-qr.firebaseio.com",
      projectId: "touchless-qr",
      storageBucket: "touchless-qr.appspot.com",
      messagingSenderId: "1069402189378",
      appId: "1:1069402189378:web:6b5314c8e86a87016607db",
      measurementId: "G-8JB2KE736F"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();

    //create some new data values
    var newData = {
      rotation: {
        x: 0,
        y: 0
      },
      motion: 0,
      orient: 0

    }

    const { easing, tween, styler, calc, listen } = window.popmotion;
    const mix = calc.getValueFromProgress;

    const boundaries = document.querySelector('.carousel');
    const box = document.querySelector('.item');
    const boxes = document.querySelectorAll('.item');
    const getBoundariesWidth = () => boundaries.getBoundingClientRect().width - box.getBoundingClientRect().width;
    const divStylers = [];
    let valX, valY = 0;
    let distance = window.innerWidth;
    let planetIndex = 1; // begin at mars
    let elementId = 'molecule';
    let startX = 0;
    [].forEach.call(boxes, function (div) {
      // do whatever
      divStylers.push(styler(div));
    });
    let uid = null;
    // checking for and adding cookies to prevent repeated additions to the db
    let previousSession = Cookies.get('touchlessqr-cookie'); // => 'value'

    let pageLoaded = false;

    // this is to prevent firebase triggering functions on page load. there may be a better way to do this
    setTimeout(function () {
      pageLoaded = true;
    }, 2000);

    //check if ipad
    isDeviceiPad();

    if (typeof previousSession === 'undefined') {
      previousSession = null;
    }
    if (previousSession != null) {
      uid = previousSession;
      console.log("cookie found - previous session id: " + previousSession);
    } else {
      // Generate a reference to a new location and add some data using push()
      var newPostRef = firebase.database().ref().push(newData);
      // Get the unique key generated by push()
      uid = newPostRef.key;
      //if no previous session found, create new cookie and add new unique field to db
      Cookies.set('touchlessqr-cookie', uid);
      console.log("New cookie id: " + Cookies.get('touchlessqr-cookie'));


    }
    //select selected planet element
    let modelViewer = document.getElementById(elementId);
    var rotX = firebase.database().ref(uid + '/rotation/x/');
    var rotY = firebase.database().ref(uid + '/rotation/y/');
    var buttonRight = firebase.database().ref(uid + '/navigate/right/');
    var buttonLeft = firebase.database().ref(uid + '/navigate/left/');
    rotX.on('value', function (snapshot) {
      valX = snapshot.val();
      modelViewer.cameraOrbit = -valX.toString() + 'deg ' + valY.toString() + 'deg auto';

    });

    rotY.on('value', function (snapshot) {
      valY = snapshot.val();
      modelViewer.cameraOrbit = -valX.toString() + 'deg ' + valY.toString() + 'deg auto';

    });

    buttonRight.on('value', function (snapshot) {
      if (pageLoaded) {
        queueForward();
      }
    });

    buttonLeft.on('value', function (snapshot) {
      if (pageLoaded) {
        queueBackward();
      }
    });


    // on left keypress slide left
    listen(boundaries, 'keydown').filter(e => e.keyCode == '37').start(() => {
      queueBackward();
    });

    // on right keypress slide right
    listen(boundaries, 'keydown').filter(e => e.keyCode == '39').start(() => {
      queueForward();
    });

    //generate qr based on uid
    let qrSize = 3;
    console.log(window.innerWidth);
    // increase qr size on fullsize screens
    if (window.innerWidth > 2000) {
      qrSize = 5;
      document.getElementById("qr-container").style.width = "11em";
      document.getElementById("qr-container").style.height = "14em";
    }
    var modelViewers = document.getElementsByTagName("model-viewer");

    console.log('num modelViewers: ' + modelViewers.length);

    var typeNumber = 4;
    var errorCorrectionLevel = 'L';
    var qr = qrcode(typeNumber, errorCorrectionLevel);
    qr.addData('https://touchless.valtech.engineering/qr/client.html?' + uid);
    qr.make();
    document.getElementById('placeHolder').innerHTML = qr.createSvgTag(qrSize);

    //queue next planet
    function queueForward() {
      if (planetIndex < 2) {
        divStylers.forEach(element =>
          tween({
            from: startX,
            to: { x: startX - distance },
            duration: 1000,
            ease: easing.anticipate
          }).
            start(element.set, console.log(distance + " " + element.get('x')))
        );
        startX -= distance;
        planetIndex++;
        getElementName();
        modelViewer = document.getElementById(elementId);
        console.log("queueing element: " + elementId);
      }
    }

    //queue prev planet
    function queueBackward() {
      if (planetIndex > 1) {

        divStylers.forEach(element =>
          tween({
            from: startX,
            to: { x: startX + distance },
            duration: 1000,
            ease: easing.anticipate
          }).
            start(element.set, console.log(distance + " " + element.get('x')))
        );
        startX += distance;
        planetIndex--;

        getElementName();
        modelViewer = document.getElementById(elementId);
        console.log("queueing element: " + elementId);
      }
    }

    // queue planet when device tilts
    function handleOrientation(event) {
      if (event.alpha < 150) {
        queueBackward();
      } else if (event.alpha > 210) {
        queueForward();
      }
    }

    // queue planet when device is shaken
    function handleMotionEvent() {
      queueForward();
    }

    function getElementName() {
      switch (planetIndex) {
        case 1:
          elementId = 'molecule';
          break;
        case 2:
          elementId = 'skin';
          break;
      }
    }

    function isDeviceiPad() {
      const iPad = (navigator.userAgent.match(/(iPad)/) /* iOS pre 13 */ ||
        (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1) /* iPad OS 13 */);
      if (iPad)
        distance = screen.height; // account for rotated ipad screen
      return iPad;
    }
  </script>

</body>

</html>